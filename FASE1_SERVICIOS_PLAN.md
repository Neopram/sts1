# ‚ö° FASE 1: COMPLETAR SERVICIOS CR√çTICOS
**Duraci√≥n: 12-16 horas | N√∫cleo del negocio**

---

## üéØ OBJETIVO FASE 1

Implementar completamente 6 servicios cr√≠ticos que constituyen el coraz√≥n del negocio:

1. ‚úÖ **commission_service.py** (70% ‚Üí 100%)
2. ‚úÖ **demurrage_service.py** (75% ‚Üí 100%)
3. ‚úÖ **compliance_service.py** (60% ‚Üí 100%)
4. ‚úÖ **notification_service.py** (65% ‚Üí 100%)
5. ‚úÖ **dashboard_projection_service.py** (80% ‚Üí 100%)
6. ‚úÖ **missing_documents_service.py** (70% ‚Üí 100%)

Resultado: L√≥gica de negocio completa y funcional

---

## üìã PRIORIZACI√ìN DE IMPLEMENTACI√ìN

### üî¥ CR√çTICOS (Implementar primero - 4-6 horas)

#### 1. **commission_service.py** - COMISIONES DE BROKER
**Por qu√© primero:** Los brokers necesitan ver comisiones en tiempo real

**Funciones a completar:**
```python
class CommissionService:
    # ‚úÖ Existentes (completar):
    async def calculate_commission(room_id, broker_id) -> float
    async def get_broker_commissions(broker_id) -> List[Commission]
    
    # ‚ùå NUEVOS:
    async def calculate_commission_on_demurrage(demurrage_total) -> float
    async def get_commission_tracking_by_broker(broker_id, start_date, end_date) -> Dict
    async def get_commission_dashboard_data(broker_id) -> Dict
    async def create_commission_record(room_id, broker_id, amount) -> Commission
    async def get_unpaid_commissions_by_broker(broker_id) -> List[Commission]
    async def mark_commission_paid(commission_id) -> Commission
```

**Testing:**
```python
@pytest.mark.asyncio
async def test_commission_on_demurrage():
    # Given: 100,000 USD demurrage acumulado
    # When: Calcular comisi√≥n al 0.5%
    # Then: Resultado = 500 USD
    pass

@pytest.mark.asyncio
async def test_commission_tracking():
    # Verificar que se trackea correctamente por broker
    pass
```

**Schemas a crear:**
```python
# app/schemas.py - AGREGAR:
class CommissionCreate(BaseModel):
    room_id: str
    broker_id: str
    demurrage_amount: float
    commission_percentage: float  # 0.5 = 0.5%
    commission_amount: float

class CommissionResponse(CommissionCreate):
    id: str
    created_at: datetime
    paid_at: Optional[datetime]
    status: str  # pending, paid, overdue
```

---

#### 2. **demurrage_service.py** - C√ÅLCULO DE DEMURRAGE
**Por qu√©:** Charterers ven esto constantemente, es cr√≠tico para decisiones de negocio

**Funciones a completar:**
```python
class DemurrageService:
    # ‚úÖ Existentes (completar):
    async def calculate_demurrage(room_id) -> float
    
    # ‚ùå NUEVOS:
    async def calculate_demurrage_accumulated(room_id) -> float
    async def calculate_demurrage_projection(room_id, days_ahead=7) -> float
    async def get_demurrage_timeline(room_id) -> List[Dict]  # Hourly breakdown
    async def get_demurrage_exposure_by_charterer(charterer_id) -> Dict
    async def calculate_demurrage_margin_impact(room_id) -> Dict  # % of total margin
    async def create_demurrage_alert(room_id, exposure_percentage) -> Alert
    async def get_demurrage_history_liquidated(room_id) -> List[Dict]
```

**L√≥gica de negocio:**
```python
# El demurrage se calcula as√≠:
# 1. ETA = Estimated Time of Arrival (fecha/hora estimada)
# 2. ATA = Actual Time of Arrival (fecha/hora real)
# 3. Si ATA > ETA ‚Üí Hay demurrage
# 4. Horas de demurrage = ATA - ETA
# 5. Demurrage daily USD = rate_per_day / 24 * hours
# 6. Total demurrage = sum(demurrage_daily)

# Ejemplo:
# Cargo: 3 millones de barriles de crudo
# Demurrage rate: $500,000/d√≠a = $20,833/hora
# Operaci√≥n tarde 48 horas
# Total demurrage = $500,000 * 2 = $1,000,000
```

**Schemas:**
```python
class DemurrageExposure(BaseModel):
    room_id: str
    current_demurrage_usd: float
    accumulated_demurrage_usd: float
    projected_demurrage_usd: float
    demurrage_rate_per_day: float
    hours_late: float
    eta_actual: datetime
    eta_estimated: datetime
    margin_impact_percentage: float  # % of operation margin
    urgency_level: str  # low, medium, high, critical
```

---

#### 3. **compliance_service.py** - CUMPLIMIENTO SIRE
**Por qu√©:** Owners necesitan verificar compliance SIRE de sus buques

**Funciones a completar:**
```python
class ComplianceService:
    # ‚úÖ Existentes:
    async def check_sire_compliance(vessel_id) -> Dict
    
    # ‚ùå NUEVOS:
    async def validate_vessel_certification(vessel_id) -> Dict
    async def check_crew_certifications(vessel_id) -> List[Dict]
    async def validate_insurance_policies(vessel_id) -> List[Dict]
    async def get_compliance_scorecard(vessel_id) -> Dict
    async def create_compliance_alert(vessel_id, issue_type, severity) -> Alert
    async def get_compliance_violations(vessel_id) -> List[Dict]
    async def track_compliance_history(vessel_id, days=90) -> List[Dict]
```

**Validaciones:**
```python
# SIRE Compliance checks:
- Certificado ISM v√°lido (Class Society)
- Certificado ISPS v√°lido (Security level 1/2/3)
- P√≥liza de seguros vigente
- Inspecciones de flag state al d√≠a
- Defects no cerrados de inspecciones anteriores
- Crew certifications vigentes
```

---

### üü° IMPORTANTES (4-6 horas)

#### 4. **notification_service.py** - NOTIFICACIONES
**Funciones a completar:**
```python
class NotificationService:
    # ‚úÖ Existentes (b√°sico):
    async def create_notification(user_id, message) -> Notification
    
    # ‚ùå NUEVOS:
    async def send_notification_to_users(user_ids: List[str], message: str, priority: str)
    async def send_email_notification(email: str, subject: str, body: str)
    async def send_in_app_notification(user_id: str, notification: Dict)
    async def get_user_notification_preferences(user_id: str) -> Dict
    async def update_notification_preferences(user_id: str, preferences: Dict)
    async def mark_notifications_as_read(user_id: str, notification_ids: List[str])
    async def create_critical_alert(room_id: str, alert_type: str, severity: str)
    async def get_unread_notifications_count(user_id: str) -> int
```

---

#### 5. **dashboard_projection_service.py** - PROYECCIONES PARA DASHBOARDS
**Funciones a completar:**
```python
class DashboardProjectionService:
    # ‚úÖ Existentes (parcial):
    async def get_admin_overview() -> Dict
    async def get_charterer_overview() -> Dict
    async def get_broker_overview() -> Dict
    
    # ‚ùå NUEVOS:
    async def get_shipowner_overview() -> Dict
    async def get_inspector_overview() -> Dict
    async def get_real_time_metrics() -> Dict
    async def get_critical_alerts() -> List[Dict]
    async def project_dashboard_for_role(role: str) -> Dict
```

**Estructura de dashboards por rol:**

```python
# ADMIN DASHBOARD
{
    "system_health": {
        "uptime": "99.9%",
        "active_users": 145,
        "pending_operations": 23,
        "critical_issues": 2
    },
    "compliance": {
        "total_vessels": 50,
        "compliant": 48,
        "non_compliant": 2,
        "violations_critical": 1
    },
    "user_management": {
        "total_users": 250,
        "active_today": 145,
        "new_this_week": 12,
        "locked_accounts": 3
    }
}

# CHARTERER DASHBOARD
{
    "demurrage_exposure": {
        "active_operations": 15,
        "total_demurrage_accumulated": 2500000,  # USD
        "total_demurrage_projected": 3200000,    # USD
        "margin_impact": 12.5  # % of total margin
    },
    "urgency_matrix": [
        {
            "operation_id": "...",
            "urgency": "critical",
            "hours_late": 48,
            "demurrage_per_hour": 20833,
            "action_required": "Approve vessel immediately"
        }
    ],
    "approvals_pending": 5
}

# BROKER DASHBOARD
{
    "commissions": {
        "active_commissions": 12,
        "total_this_month": 145000,  # USD
        "total_this_year": 1850000,  # USD
        "pending_payment": 3,
        "paid_this_month": 9
    },
    "deal_health": [
        {
            "room_id": "...",
            "status": "active",
            "parties_count": 4,
            "documents_approved": 8,
            "documents_pending": 2,
            "risk_level": "low"
        }
    ]
}
```

---

#### 6. **missing_documents_service.py** - DOCUMENTOS FALTANTES
**Funciones a completar:**
```python
class MissingDocumentsService:
    # ‚úÖ Existentes (70%):
    async def get_missing_documents(room_id) -> List[Document]
    
    # ‚ùå NUEVOS:
    async def detect_missing_documents_auto(room_id) -> List[Dict]
    async def get_sla_tracking(room_id) -> Dict
    async def create_critical_missing_alert(room_id, doc_type) -> Alert
    async def get_missing_documents_statistics() -> Dict
    async def get_documents_expiring_soon(days=7) -> List[Dict]
    async def generate_missing_documents_report(room_id) -> Dict
```

---

## üìù CHECKLIST FASE 1

### Implementaci√≥n

- [ ] **commission_service.py completado** (100%)
  - [ ] C√°lculo de comisi√≥n base funciona
  - [ ] C√°lculo sobre demurrage funciona
  - [ ] Dashboard de comisiones funciona
  - [ ] Tests pasando
  - [ ] Documentaci√≥n completada

- [ ] **demurrage_service.py completado** (100%)
  - [ ] C√°lculo acumulado funciona
  - [ ] Proyecci√≥n funciona
  - [ ] Timeline funciona
  - [ ] Alertas funciona
  - [ ] Tests pasando

- [ ] **compliance_service.py completado** (100%)
  - [ ] Validaciones SIRE funciona
  - [ ] Crew certifications funciona
  - [ ] Insurance validation funciona
  - [ ] Scorecard funciona
  - [ ] Tests pasando

- [ ] **notification_service.py completado** (100%)
  - [ ] Creaci√≥n de notificaciones funciona
  - [ ] Email notifications funciona
  - [ ] Preferences funciona
  - [ ] Tests pasando

- [ ] **dashboard_projection_service.py completado** (100%)
  - [ ] Admin dashboard funciona
  - [ ] Charterer dashboard funciona
  - [ ] Broker dashboard funciona
  - [ ] Owner dashboard funciona
  - [ ] Tests pasando

- [ ] **missing_documents_service.py completado** (100%)
  - [ ] Auto-detection funciona
  - [ ] SLA tracking funciona
  - [ ] Alerts funciona
  - [ ] Reports funciona
  - [ ] Tests pasando

### Testing

- [ ] Todos los servicios tienen tests unitarios
- [ ] Cobertura >80%
- [ ] Integration tests funcionan
- [ ] Datos de prueba cargados

### Documentaci√≥n

- [ ] Docstrings en todas las funciones
- [ ] README.md de cada servicio
- [ ] Examples en documentaci√≥n

---

## üöÄ ORDEN DE EJECUCI√ìN

```
1. commission_service.py       (2-3 horas)
   ‚Üì
2. demurrage_service.py        (2-3 horas)
   ‚Üì
3. compliance_service.py       (2-3 horas)
   ‚Üì
4. notification_service.py     (1-2 horas)
   ‚Üì
5. dashboard_projection_service.py (2-3 horas)
   ‚Üì
6. missing_documents_service.py (1-2 horas)
   ‚Üì
‚úÖ FASE 1 COMPLETADA
```

**Total: 12-16 horas**

---

## üìä PROGRESO

```
FASE 0: ‚úÖ 100% (COMPLETADA)
FASE 1: ‚è≥ 0% ‚Üí 100% (COMIENZA AHORA)
        ‚îú‚îÄ commission_service.py        [          ] 0%
        ‚îú‚îÄ demurrage_service.py         [          ] 0%
        ‚îú‚îÄ compliance_service.py        [          ] 0%
        ‚îú‚îÄ notification_service.py      [          ] 0%
        ‚îú‚îÄ dashboard_projection_service [          ] 0%
        ‚îî‚îÄ missing_documents_service.py [          ] 0%

FASE 2: ‚è≥ Pendiente (Routers)
FASE 3: ‚è≥ Pendiente (WebSocket)
FASE 4: ‚è≥ Pendiente (Frontend)
FASE 5: ‚è≥ Pendiente (Integraci√≥n)
FASE 6: ‚è≥ Pendiente (Testing LAN)
FASE 7: ‚è≥ Pendiente (Optimizaci√≥n)

TOTAL: 0% ‚Üí 100%
```

---

## üîß C√ìMO EJECUTAR FASE 1

### Paso 1: Activar entorno
```powershell
cd c:\Users\feder\Desktop\StsHub\sts
.\.venv\Scripts\Activate.ps1
```

### Paso 2: Iniciar backend
```powershell
python backend\run_server.py
```

### Paso 3: En otra terminal, comenzar implementaci√≥n
```powershell
# Cambiar al directorio de backend
cd backend\app\services

# Editar commission_service.py y agregar funciones nuevas
code commission_service.py

# Escribir tests
cd ../
python -m pytest tests/ -v
```

### Paso 4: Verificar cada cambio
```powershell
# Antes de pasar a siguiente servicio
python -m pytest tests/test_commission_service.py -v

# Si todo est√° bien, pasar al siguiente:
# demurrage_service.py
```

---

## üíæ ARCHIVOS A MODIFICAR

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commission_service.py        ‚ö° MODIFICAR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ demurrage_service.py         ‚ö° MODIFICAR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compliance_service.py        ‚ö° MODIFICAR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification_service.py      ‚ö° MODIFICAR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard_projection_service.py ‚ö° MODIFICAR
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ missing_documents_service.py ‚ö° MODIFICAR
‚îÇ   ‚îú‚îÄ‚îÄ schemas.py                       ‚ö° AGREGAR NUEVOS SCHEMAS
‚îÇ   ‚îî‚îÄ‚îÄ models.py                        ‚úÖ OK (sin cambios necesarios)
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_commission_service.py       ‚ú® CREAR
‚îÇ   ‚îú‚îÄ‚îÄ test_demurrage_service.py        ‚ú® CREAR
‚îÇ   ‚îú‚îÄ‚îÄ test_compliance_service.py       ‚ú® CREAR
‚îÇ   ‚îú‚îÄ‚îÄ test_notification_service.py     ‚ú® CREAR
‚îÇ   ‚îú‚îÄ‚îÄ test_dashboard_projection.py     ‚ú® CREAR
‚îÇ   ‚îî‚îÄ‚îÄ test_missing_documents.py        ‚ú® CREAR
‚îÇ
‚îî‚îÄ‚îÄ requirements.txt                     ‚úÖ OK (todas las dependencias est√°n)
```

---

## üéì PUNTOS CLAVE

1. **Mantener cohesi√≥n:** Los servicios trabajan juntos
   - demurrage_service calcula el demurrage
   - commission_service lo usa para calcular comisiones
   - dashboard_projection_service los usa para dashboards

2. **Testing es cr√≠tico:** Cada funci√≥n nueva tiene test
   - Unit tests primero
   - Integration tests segundo
   - Manual testing tercero

3. **No romper existente:** Los cambios son aditivos
   - No eliminar funciones existentes
   - No cambiar signatures existentes
   - Agregar nuevas funciones

4. **Documentaci√≥n en vivo:** Documentar mientras se implementa
   - Docstrings claros
   - Ejemplos en c√≥digo
   - README actualizado

---

**FASE 1: COMIENZA AHORA**  
*Duraci√≥n: 12-16 horas*  
*Criticidad: M√ÅXIMA*  
*Siguiente: Ejecutar PASO 1 - commission_service.py*
